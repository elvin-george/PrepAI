{% extends "base.html" %}

{% block content %}
<div class="h-[calc(100vh-100px)] flex flex-col p-4 lg:p-6">
    
    <div class="bg-white dark:bg-gray-800 p-4 rounded-t-2xl border-b border-gray-100 dark:border-gray-700 flex justify-between items-center shadow-sm">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-full bg-brand-100 dark:bg-brand-900/50 flex items-center justify-center text-brand-600">
                <i class="fas fa-robot text-lg"></i>
            </div>
            <div>
                <h2 class="font-bold text-gray-900 dark:text-white">PrepAI Assistant</h2>
                <p class="text-xs text-green-500 font-medium flex items-center gap-1">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Online • RAG Active
                </p>
            </div>
        </div>
        <button onclick="clearChat()" class="text-gray-400 hover:text-red-500 text-sm">
            <i class="fas fa-trash-alt"></i> Clear
        </button>
    </div>

    <div id="chatBox" class="flex-1 bg-gray-50 dark:bg-gray-900 overflow-y-auto p-4 space-y-4">
        <div class="flex gap-3">
            <div class="w-8 h-8 rounded-full bg-brand-600 flex items-center justify-center text-white shrink-0 text-xs">AI</div>
            <div class="bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 p-3 rounded-2xl rounded-tl-none shadow-sm max-w-[80%] text-sm">
                Hello! I am trained on your college documents. Ask me about the syllabus, placement rules, or eligibility criteria.
            </div>
        </div>
    </div>

    <div class="bg-white dark:bg-gray-800 p-4 rounded-b-2xl shadow-lg">
        <form id="chatForm" class="flex gap-2">
            <input type="text" id="userInput" placeholder="Ask about syllabus, drives, etc..." autocomplete="off"
                class="flex-1 bg-gray-100 dark:bg-gray-700 border-0 text-gray-900 dark:text-white rounded-xl px-4 py-3 focus:ring-2 focus:ring-brand-500 outline-none">
            <button type="submit" id="sendBtn" 
                class="bg-brand-600 hover:bg-brand-700 text-white px-6 py-3 rounded-xl font-bold transition-all flex items-center gap-2">
                <i class="fas fa-paper-plane"></i>
            </button>
        </form>
    </div>
</div>

<script>
    const chatBox = document.getElementById('chatBox');
    const chatForm = document.getElementById('chatForm');
    const userInput = document.getElementById('userInput');

    function appendMessage(text, isUser) {
        const div = document.createElement('div');
        div.className = isUser ? "flex gap-3 justify-end" : "flex gap-3";
        
        const bubble = document.createElement('div');
        bubble.className = isUser 
            ? "bg-brand-600 text-white p-3 rounded-2xl rounded-tr-none shadow-md max-w-[80%] text-sm"
            : "bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-200 p-3 rounded-2xl rounded-tl-none shadow-sm max-w-[80%] text-sm";
        
        bubble.innerHTML = text.replace(/\n/g, '<br>'); // Simple Markdown-ish
        div.appendChild(bubble);
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const msg = userInput.value.trim();
        if (!msg) return;

        // 1. Show User Message
        appendMessage(msg, true);
        userInput.value = '';
        
        // 2. Show Loading Indicator
        const loadingDiv = document.createElement('div');
        loadingDiv.className = "flex gap-3";
        loadingDiv.innerHTML = `<div class="w-8 h-8 bg-brand-600 rounded-full flex items-center justify-center text-white text-xs">AI</div><div class="bg-gray-200 dark:bg-gray-700 p-3 rounded-2xl rounded-tl-none text-sm animate-pulse">Thinking...</div>`;
        chatBox.appendChild(loadingDiv);
        chatBox.scrollTop = chatBox.scrollHeight;

        try {
            // 3. Call API
            const res = await fetch('/student/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: msg })
            });
            const data = await res.json();
            
            // 4. Remove Loading & Show AI Response
            chatBox.removeChild(loadingDiv);
            appendMessage(data.response, false);
        } catch (err) {
            chatBox.removeChild(loadingDiv);
            appendMessage("❌ Error connecting to server.", false);
        }
    });
</script>
{% endblock %}