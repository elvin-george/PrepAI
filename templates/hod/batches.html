{% extends "base.html" %}

{% block content %}
<div class="p-6 lg:p-10">
    <div class="mb-6">
        <a href="{{ url_for('hod.dashboard') }}"
            class="text-sm font-medium text-gray-500 hover:text-brand-600 transition-colors">
            <i class="fas fa-arrow-left mr-1"></i> Back to Dashboard
        </a>
    </div>
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Batch Management</h1>
        <button onclick="document.getElementById('batch-modal').classList.remove('hidden')"
            class="bg-brand-600 hover:bg-brand-700 text-white px-6 py-2 rounded-xl font-bold">
            <i class="fas fa-plus mr-2"></i> Create Batch
        </button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for batch in batches %}
        <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white">{{ batch.batch_name }}</h3>
                    <p class="text-sm text-gray-500">{{ batch.department }} | {{ batch.current_semester }}</p>
                </div>
                <div class="flex gap-2">
                    <button
                        onclick='openEditModal({ id: "{{ batch.id }}", name: "{{ batch.batch_name }}", dept: "{{ batch.department }}", sem: "{{ batch.current_semester }}", csa: "{{ batch.csa_id or "" }}" })'
                        class="p-2 bg-blue-50 hover:bg-blue-100 text-blue-600 rounded-lg transition-colors"
                        title="Edit Batch">
                        <i class="fas fa-edit"></i>
                    </button>
                    <a href="{{ url_for('hod.delete_batch', batch_id=batch.id) }}"
                        class="p-2 bg-red-50 hover:bg-red-100 text-red-500 hover:text-red-700 rounded-lg transition-colors"
                        onclick="return confirm('Delete batch?')" title="Delete Batch">
                        <i class="fas fa-trash"></i>
                    </a>
                </div>
            </div>

            <div class="mt-4 pt-4 border-t border-gray-100 dark:border-gray-700">
                <p class="text-xs font-bold text-gray-500 uppercase mb-1">Staff Advisor (CSA)</p>
                {% if batch.csa_id %}
                <span
                    class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                    <i class="fas fa-user-check mr-2"></i> Assigned
                </span>
                {% else %}
                <span
                    class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
                    <i class="fas fa-exclamation-triangle mr-2"></i> Unassigned
                </span>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<div id="batch-modal"
    class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-gray-900/50 backdrop-blur-sm">
    <div
        class="bg-white dark:bg-gray-800 rounded-2xl w-full max-w-lg p-6 shadow-xl border border-gray-100 dark:border-gray-700">
        <h3 id="modal-title" class="text-xl font-bold mb-6 text-gray-900 dark:text-white">Create New Batch</h3>
        <form id="batch-form" action="{{ url_for('hod.batches') }}" method="POST" class="space-y-4">
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Batch ID (Unique)</label>
                <input type="text" name="batch_id" id="field_id" placeholder="e.g. mca_2024_2026" required
                    class="w-full px-4 py-2 rounded-xl border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-brand-500 transition-all disabled:opacity-60 disabled:cursor-not-allowed">
                <p id="id-help" class="text-xs text-gray-400 mt-1">This ID connects students to the batch.</p>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Display Name</label>
                <input type="text" name="batch_name" id="field_name" placeholder="e.g. MCA 2024-2026" required
                    class="w-full px-4 py-2 rounded-xl border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-brand-500">
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Department</label>
                    <select name="department" id="field_dept"
                        class="w-full px-4 py-2 rounded-xl border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-brand-500">
                        <option value="MCA">MCA</option>
                        <option value="CSE">CSE</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Semester</label>
                    <select name="semester" id="field_sem"
                        class="w-full px-4 py-2 rounded-xl border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-brand-500">
                        <option value="S1">S1</option>
                        <option value="S2">S2</option>
                        <option value="S3">S3</option>
                        <option value="S4">S4</option>
                    </select>
                </div>
            </div>
            <div>
                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Assign CSA</label>
                <select name="csa_id" id="field_csa"
                    class="w-full px-4 py-2 rounded-xl border border-gray-200 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-brand-500">
                    <option value="">-- Select Staff Advisor --</option>
                    {% for csa in csas %}
                    <option value="{{ csa.id }}">{{ csa.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="flex gap-3 pt-4">
                <button type="button" onclick="closeModal()"
                    class="flex-1 py-2 rounded-xl text-gray-600 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700 transition-colors">Cancel</button>
                <button type="submit"
                    class="flex-1 py-2 rounded-xl bg-brand-600 hover:bg-brand-700 text-white font-bold shadow-lg shadow-brand-500/20 transition-all">Save
                    Batch</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openCreateModal() {
        document.getElementById('batch-modal').classList.remove('hidden');
        document.getElementById('batch-form').reset();
        document.getElementById('modal-title').innerText = "Create New Batch";

        // Enable ID field
        const idField = document.getElementById('field_id');
        idField.readOnly = false;
        idField.disabled = false;
        idField.classList.remove('bg-gray-100', 'dark:bg-gray-800');
    }

    function openEditModal(data) {
        document.getElementById('batch-modal').classList.remove('hidden');
        document.getElementById('modal-title').innerText = "Edit Batch";

        // Populate Fields
        document.getElementById('field_id').value = data.id;
        document.getElementById('field_name').value = data.name;
        document.getElementById('field_dept').value = data.dept;
        document.getElementById('field_sem').value = data.sem;
        document.getElementById('field_csa').value = data.csa;

        // Lock ID field (Primary Key)
        const idField = document.getElementById('field_id');
        idField.readOnly = true;
        idField.classList.add('bg-gray-100', 'dark:bg-gray-800');
    }

    function closeModal() {
        document.getElementById('batch-modal').classList.add('hidden');
    }
</script>
{% endblock %}